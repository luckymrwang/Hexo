title: "月末审计数据"
date: 2015-05-21 10:06:48
tags: [BI项目]
---
##游戏快照
*功能：查看某个时间段内的支付用户在此刻的快照数据*

*cli 运行方式：* 
			
	nohup php index.php accountant/audit/snapshot tank 2011-01-01 2015-04-30 > snapshot/tank_snapshot_2011_2015.txt &
<!-- more -->
*CI中的网页查看方式：*

	Http://.../accountant/audit/snapshot/world_war/2015-05-01/2015-05-01

具体流程如下：

1.遍历该游戏下的所有大平台，遍历某个大平台下的所有区服

2.通过大平台，区服，时间段取到所有的支付用户ID

3.将所有的支付用户分批次，每30个为一组，作为url参数之一；根据大平台和区服到数据库中取对应的拉取数据的url地址，与上面的参数，以及验签拼接成一个完整的url地址，例子如下：

	[url] => worldwar-shouyou-ios-web01.raysns.com/tank-server/public/index.php/getstat?userids=[{"zid":1,"userids":["1036461","1004034","1039689","1020481","1010641","1007554","1031727","1005429","1005705","1029936"]}]&is_compress=1&type=get_user_audit_infos&sign=6520b6d1274a1e221a6f6b7ba52989f3

4.将多个url放到一个数组中，实现并发访问获取远端数据 //*为防止给远端服务器造成压力，并发时一台服务器对应一个url,通过循环调用如下函数进行帅选*

	public function get_request_nums(&$data){
		$ret = array();
		foreach($data as $key => $value){
			if(empty($value))
				continue;
			$last_key = count($value) - 1;
			$ret[] = $value[$last_key];
			unset($data[$key][$last_key]);
		}
		return $ret;
	}

5.将信息显示出来


##前两万名用户详情表
*功能：查看某个游戏某一个时间段内前两万名用户的详情*

*cli 运行方式：* 

	nohup php index.php accountant/audit/top_pay_users_by_period_cli tank 2011-01-01 2015-04-30 1~20000 > top/tank_top_2011_2015.txt &
<!-- more -->
*CI中的网页查看方式：*
	http://.../accountant/audit/top_pay_users_by_period_cli/tank/2015-05-01/2015-05-01/1~20000

具体流程如下：

1.调用函数 `_top_pay_users` 

2.调用函数 `_get_top_users_by_game` ，在该函数中做如下操作 通过
`$game_name, $start_date, $end_date, $rank_from, $rank_to`
这几个参数以*curl* 的方式访问*go*的接口来获取这个游戏这个时间段内的前两万名用户信息，之后再处理填充用户信息，具体如下：

- 从*go*接口返回的信息：
- 
	Array
	(
    	[appTotalCosts] => Array
        	(
            	[1009] => 21376
            	[1011] => 107498
            	[1013] => 202793.76
            	[1014] => 20004.21
            	[1015] => 471750.89
            	[1016] => 258342
            	[1017] => 237508
            	[1018] => 88136.06
            	[1019] => 2941.68
            	[1020] => 143607
            	[1021] => 0
            	[1023] => 0
            	[1024] => 13014.79
            	[1025] => 91822.11
            	[1026] => 67377.12
            	[1027] => 1495.04
            	[1028] => 18.11
            	[1029] => 249943.2
            	[1031] => 85085.72
            	[1032] => 996.43
            	[1033] => 786.04
            	[1034] => 0
        	)

    	[gameTopUsers] => Array
        	(
        	    [0] => Array
        	        (
        	            [bigAppId] => 1017
        	            [zid] => 49
        	            [userId] => 49017166
        	            [cost] => 13936
        	            [tradeType] => ioshaima
        	            [payTimes] => 22
        	        )

        	    [1] => Array
        	        (
        	            [bigAppId] => 1016
        	            [zid] => 45
        	            [userId] => 45004559
        	            [cost] => 12960
        	            [tradeType] => flappstore
        	            [payTimes] => 20
        	        )
			）
	）

- 第一次加工处理的信息：
- 
	Array
	(
    	[1017#49017166] => Array
    	    (
    	        [big_app_id] => 1017
    	        [zid] => 49
    	        [user_id] => 49017166
    	        [rank] => 1
    	        [cost] => 13936
    	        [money_type] => CNY
    	        [trade_type] => ioshaima
    	        [pay_times] => 22
    	        [cost_percent] => 67.5
    	    )
	
    	[1016#45004559] => Array
    	    (
    	        [big_app_id] => 1016
    	        [zid] => 45
    	        [user_id] => 45004559
    	        [rank] => 2
    	        [cost] => 12960
    	        [money_type] => CNY
    	        [trade_type] => flappstore
    	        [pay_times] => 20
    	        [cost_percent] => 62.78
    	    )
	）


3.调用函数 `_merge_user_cost_and_audit` ，通过*curl*获取远端用户审计信息，最终与之前的消费信息合并

- curl获取远端信息格式如下：
- 
	Array
	(
    	[0] => Array
    	    (
    	        [user_id] => 49000507
    	        [name] => 稻草人
    	        [level] => 31
    	        [vip_level] => 4
    	        [reg_time] => 1429851196
    	        [last_login_time] => 1432201556
    	        [last_pay_time] => 1430459153
    	        [total_online_time] => 348361
    	        [total_login_day_count] => 25
    	        [last_login_ip] => 113.200.85.123
    	        [remain_coin] => 16
    	        [total_buy_coin] => 4750
    	        [total_gift_coin] => 5508
    	        [zid] => 49
    	        [nonstop_login_day_count] => 0
    	        [pid] => 
    	    )
	）

- 最终合并格式如下：
- 
	Array
	(
    	[big_app_id] => 1017
    	[zid] => 49
    	[user_id] => 49000507
    	[rank] => 6517
    	[cost] => 18
    	[money_type] => CNY
    	[trade_type] => iosaisi
    	[pay_times] => 1
    	[cost_percent] => 0.09
    	[name] => 稻草人
    	[level] => 31
    	[vip_level] => 4
    	[reg_time] => 2015-04-24 12:53:16
    	[last_login_time] => 2015-05-22 13:55:30
    	[last_pay_time] => 2015-05-01 13:45:53
    	[total_online_time] => 357174
    	[total_login_day_count] => 26
    	[last_login_ip] => 113.200.85.123
    	[remain_coin] => 18
    	[total_buy_coin] => 4750
    	[total_gift_coin] => 5516
    	[nonstop_login_day_count] => 0
    	[pid] => 
    	[game_desc] => 坦克
    	[partner] => 深圳市为爱普信息技术有限公司
    	[big_app_desc] => 坦克_越狱ios_飞流
    	[audit_sub_app_desc] => 自营爱思助手_ios
    	[sales_mode] => 自研自营
    	[country] => 中国大陆
    	[shore] => 境内
    	[period] => 2015-05-01~2015-05-01
	)

4.将信息显示出来

