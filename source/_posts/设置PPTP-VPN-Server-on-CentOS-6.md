title: 设置PPTP VPN Server on CentOS 6
date: 2016-08-07 19:22:30
tags: [CentOS,PPTP]
toc: true
---

### 以`yum`安装VPN服务

	yum install -y pptpd
	
### 修改配置文件


#### 修改`/etc/ppp/options.pptpd`

```
name pptpd
refuse-pap
refuse-chap
refuse-mschap
require-mschap-v2
require-mppe-128
proxyarp
lock
nobsdcomp 
novj
novjccomp
nologfd
ms-dns 8.8.8.8
ms-dns 8.8.4.4
```
*ms-dns 8.8.8.8， ms-dns 8.8.4.4是使用google的dns服务器*

<!-- more -->
#### 修改`/etc/ppp/chap-secrets`

增加用户名和密码，比如

	vultr1  pptpd   P@$$w0rd  *

*\*表示所有ip*


#### 修改`/etc/pptpd.conf`

```
option /etc/ppp/options.pptpd
logwtmp
localip 192.168.0.1 //表示VPN拨号后，客户端在连接里面看到的VPN服务器IP
remoteip 192.168.0.234-238,192.168.0.245 // //表示vpn客户端获得ip的范围
```

#### `/etc/sysctl.conf`

运行下面的命令修改sysctl.conf

```
sed -i 's/^net.ipv4.ip_forward.*/net.ipv4.ip_forward = 1/g' /etc/sysctl.conf
```

并执行下面的命令来生效它

	sysctl -p

#### 配置转发规则

```
iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 1723 -j ACCEPT
```

转发规则

	iptables -t nat -A POSTROUTING -o eth0 -s 192.168.0.0/24 -j MASQUERADE
	
*其中的IP[192.168.0.0]必须与上面的IP范围中的一致*

保存配置

	service iptables save
	
重启服务

	service iptables start
	
**这个地方有一个大坑，执行命令`vi /etc/sysconfig/iptables`打开防火墙配置如下**

```
# Generated by iptables-save v1.4.7 on Sun Aug  7 10:32:37 2016
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE
COMMIT
# Completed on Sun Aug  7 10:32:37 2016
# Generated by iptables-save v1.4.7 on Sun Aug  7 10:32:37 2016
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [29:3140]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 1723 -j ACCEPT
-A INPUT -p gre -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Sun Aug  7 10:32:37 2016
```
其中20行`-A INPUT -p gre -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
COMMIT`必须在`-A INPUT -p tcp -m state --state NEW -m tcp --dport 1723 -j ACCEPT`和
`-A INPUT -p gre -j ACCEPT`两行代码的下面，否则无法登录VPN

### 开启PPTP

	service pptpd start
	
引自[这里](https://www.vultr.com/docs/setup-pptp-vpn-server-on-centos-6)
